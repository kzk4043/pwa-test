# テスト手順

## テスト環境の準備

### 必要な環境
1. **HTTPSサーバー**（PWA動作には必須）
   - GitHub Pages（推奨）
   - Netlify、Vercel等
   - ローカル：`python -m http.server 8000` + ngrok

2. **テスト対象ブラウザ**
   - Android Chrome（最新版）
   - iOS Safari 16.4+（プッシュ通知テスト用）
   - Desktop Chrome（開発用）

3. **開発ツール**
   - Chrome DevTools
   - Android Debug Bridge（adb）
   - Xcode Simulator（iOS開発者向け）

## 基本的なテスト手順

### 1. ローカル環境でのテスト

#### HTTP Serverの起動
```bash
# Python使用の場合
cd /path/to/pwa-test
python -m http.server 8000

# Node.js使用の場合  
npx serve -p 8000

# PHP使用の場合
php -S localhost:8000
```

#### HTTPS環境の準備（推奨）
```bash
# ngrokを使用したHTTPS化
ngrok http 8000

# 表示されるHTTPS URLでアクセス
# https://abc123.ngrok.io
```

### 2. Chrome DevToolsでの基本チェック

#### Service Worker確認
1. F12でDevToolsを開く
2. `Application` タブを選択
3. `Service Workers` セクションで確認項目：
   - ✅ Status: "activated and is running"
   - ✅ Source: "/sw.js"
   - ✅ Update on reload: チェック（開発時）

#### Manifest確認
1. `Application` > `Manifest` で確認項目：
   - ✅ Identity
     - Name: "PWA機能テストアプリ"
     - Short name: "PWAテスト"
   - ✅ Presentation
     - Start URL: "/"
     - Display: "standalone"
   - ✅ Icons: 各サイズが正しく表示される

#### Cache確認
1. `Application` > `Storage` > `Cache Storage`
2. 確認項目：
   - ✅ "pwa-test-cache-v1" が存在
   - ✅ キャッシュされたファイル一覧が表示される
   - ✅ 各ファイルのレスポンスが確認できる

### 3. PWA要件の Lighthouse 監査

#### Lighthouse実行手順
1. Chrome DevToolsの `Lighthouse` タブ
2. Categories: `Progressive Web App` のみチェック
3. `Analyze page load` をクリック

#### 合格基準
- **PWAスコア: 90以上** を目標
- 主要チェック項目：
  - ✅ Installable
  - ✅ PWA Optimized
  - ✅ Serves valid manifest
  - ✅ Has a service worker

### 4. オフライン機能テスト

#### Chrome DevToolsでのオフラインシミュレーション
1. `Network` タブを開く
2. `Online` プルダウン → `Offline` を選択
3. ページをリロード

#### 確認項目
- ✅ オフライン状態でもページが表示される
- ✅ キャッシュされたリソースが正常に読み込まれる
- ✅ オフラインページ（offline.html）が表示される（未キャッシュページアクセス時）
- ✅ "オフラインです" メッセージが表示される

#### 実際のネットワーク切断テスト
1. WiFi/データ通信を切断
2. ブラウザでページアクセス
3. 基本機能が動作することを確認

## Android実機でのテスト手順

### 1. 事前準備
```bash
# Android端末でのデベロッパーオプション有効化
# 設定 > システム > ビルド番号を7回タップ
# 設定 > システム > 開発者向けオプション > USBデバッグを有効化
```

### 2. Chrome Remote Debuggingの設定
1. Android端末をUSBでPCに接続
2. PC Chrome で `chrome://inspect` にアクセス
3. "Discover USB devices" をチェック
4. 端末側でデバッグ許可

### 3. PWAインストールテスト

#### インストール可能性の確認
1. Android Chrome でPWAサイトにアクセス
2. URL バー右側にインストールアイコン（⊕）が表示されることを確認
3. またはメニュー > "アプリをインストール" が表示される

#### カスタムインストールUIテスト
1. ページ内の「PWAをインストール」ボタンをタップ
2. 確認項目：
   - ✅ ボタンが有効化される（disabled属性が外れる）
   - ✅ ボタンタップ時にインストールダイアログが表示される
   - ✅ "追加" ボタンでインストール完了
   - ✅ ホーム画面にアプリアイコンが追加される

#### インストール後の動作確認
1. ホーム画面からアプリを起動
2. 確認項目：
   - ✅ スプラッシュスクリーンが表示される
   - ✅ ブラウザのUIが隠れてアプリライクに表示
   - ✅ ステータスバーが適切に表示される

### 4. プッシュ通知テスト（Android）

#### 通知許可テスト
1. "通知を有効化" ボタンをタップ
2. 確認項目：
   - ✅ システムの通知許可ダイアログが表示される
   - ✅ "許可" 選択後にボタンが "通知有効化済み" に変更
   - ✅ "テスト通知" ボタンが有効化される

#### テスト通知の送信
1. "テスト通知" ボタンをタップ
2. 確認項目：
   - ✅ 通知がシステム通知エリアに表示される
   - ✅ アイコン、タイトル、メッセージが正しく表示
   - ✅ 通知タップでアプリが開く

#### バックグラウンド通知テスト
1. アプリをバックグラウンドに移動
2. "テスト通知" を送信（または自動送信設定）
3. 確認項目：
   - ✅ アプリが非アクティブでも通知受信
   - ✅ 通知音・バイブレーション動作
   - ✅ 通知タップでアプリがフォアグラウンドに復帰

## iOS Safari でのテスト手順

### 1. 基本動作テスト（iOS 全バージョン）

#### PWA基本機能
1. iOS Safari でサイトにアクセス
2. 確認項目：
   - ✅ ページが正常に表示される
   - ✅ Service Worker が登録される（iOS 11.3+）
   - ✅ オフライン機能が動作する

#### インストールテスト
1. Safari の共有ボタン（↗️）をタップ
2. "ホーム画面に追加" を選択
3. 確認項目：
   - ✅ アプリ名とアイコンがプレビュー表示
   - ✅ "追加" タップでホーム画面に追加される
   - ✅ フルスクリーンでアプリが起動する

### 2. プッシュ通知テスト（iOS 16.4+のPWAのみ）

#### 前提条件の確認
- iOS バージョンが 16.4 以降
- PWAがホーム画面にインストール済み
- PWAをホーム画面から起動している（Safariブラウザ内では不可）

#### 通知許可とテスト
1. インストール済みPWAを起動
2. "通知を有効化" ボタンをタップ
3. システムの通知許可ダイアログを確認
4. "テスト通知" で通知が表示されることを確認

**注意**: iOS 16.4未満、またはSafariブラウザ内では通知機能は動作しません。

## パフォーマンステスト

### 1. Core Web Vitals測定

#### Lighthouse Performance監査
1. Chrome DevTools > Lighthouse
2. Categories: Performance をチェック
3. 目標値：
   - **FCP (First Contentful Paint)**: < 1.8秒
   - **LCP (Largest Contentful Paint)**: < 2.5秒
   - **CLS (Cumulative Layout Shift)**: < 0.1

#### Real User Monitoring
```javascript
// Web Vitals 測定コード（参考）
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

getCLS(console.log);
getFID(console.log);
getFCP(console.log);
getLCP(console.log);
getTTFB(console.log);
```

### 2. キャッシュ効率テスト

#### 初回アクセス vs リピートアクセス
1. **初回アクセス**（キャッシュクリア後）
   - 全リソースがネットワークから読み込まれる
   - Service Worker がインストールされる

2. **リピートアクセス**（キャッシュ有効状態）  
   - 静的リソースがキャッシュから高速読み込み
   - ネットワークリクエストが最小限になる

#### 測定方法
```bash
# Chrome DevTools Network タブで確認
# Size 列で "from ServiceWorker" または "from disk cache" を確認
```

## トラブルシューティング

### よくある問題と解決法

#### 1. Service Worker が登録されない
**症状**: Application タブに Service Worker が表示されない

**チェック項目**:
- ✅ HTTPS環境で実行しているか（localhostは例外）
- ✅ sw.js ファイルが正しいパスに存在するか
- ✅ JavaScriptエラーが発生していないか
- ✅ CORS設定が正しいか

**解決法**:
```javascript
// エラー詳細の確認
navigator.serviceWorker.register('/sw.js')
  .then(registration => {
    console.log('SW登録成功:', registration);
  })
  .catch(error => {
    console.error('SW登録失敗:', error);
  });
```

#### 2. PWAインストールボタンが表示されない
**症状**: インストールプロンプトが発火しない

**チェック項目**:
- ✅ Manifest ファイルが有効か
- ✅ Service Worker が正常に動作しているか
- ✅ 必須アイコンサイズ（192x192）が存在するか
- ✅ start_url が正しく設定されているか

**確認方法**:
```bash
# Chrome DevTools Console で実行
navigator.serviceWorker.getRegistration().then(reg => {
  console.log('SW登録状況:', reg);
});
```

#### 3. オフライン時にページが表示されない
**症状**: ネットワーク切断時に "恐竜ゲーム" が表示される

**チェック項目**:
- ✅ 必要なファイルが事前キャッシュされているか
- ✅ fetch イベントハンドラが正しく実装されているか
- ✅ オフラインページがキャッシュされているか

**デバッグ方法**:
```javascript
// キャッシュ内容の確認
caches.keys().then(names => {
  names.forEach(name => {
    caches.open(name).then(cache => {
      cache.keys().then(keys => {
        console.log(`Cache ${name}:`, keys.map(k => k.url));
      });
    });
  });
});
```

#### 4. iOS でプッシュ通知が動作しない
**症状**: iOS で通知が表示されない

**チェック項目**:
- ✅ iOS 16.4 以降のバージョンか
- ✅ PWAをホーム画面からインストールしているか
- ✅ Safari ブラウザではなくPWAアプリから実行しているか
- ✅ システム設定で通知が許可されているか

**確認方法**:
```javascript
// iOS 環境の詳細チェック
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
const hasPushManager = 'PushManager' in window;

console.log('iOS:', isIOS);
console.log('Standalone:', isStandalone);  
console.log('PushManager:', hasPushManager);
```

## テスト自動化

### 基本的な E2E テストスクリプト
```javascript
// Playwright での PWA テスト例
const { test, expect } = require('@playwright/test');

test('PWA基本機能テスト', async ({ page, context }) => {
  // サービスワーカー登録確認
  await page.goto('https://your-pwa-url.com');
  
  const serviceWorker = await context.serviceWorkers();
  expect(serviceWorker).toBeTruthy();

  // マニフェスト確認
  const manifestResponse = await page.request.get('/manifest.json');
  expect(manifestResponse.ok()).toBe(true);
  
  // オフラインテスト
  await context.setOffline(true);
  await page.reload();
  
  const title = await page.title();
  expect(title).toContain('PWA');
});
```

## 継続的なモニタリング

### 本番環境でのチェック項目
1. **週次チェック**
   - PWAスコアの維持（Lighthouse）
   - Core Web Vitals の測定
   - 主要ブラウザでの動作確認

2. **月次チェック**
   - 新ブラウザバージョンでの互換性確認
   - モバイル実機でのテスト
   - パフォーマンス回帰チェック

3. **四半期チェック**
   - PWA新機能への対応検討
   - セキュリティアップデート適用
   - ユーザーフィードバック分析

このテスト手順に従って実装することで、確実に動作するPWAを構築できます。